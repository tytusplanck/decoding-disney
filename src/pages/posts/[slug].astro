---
import BaseLayout from '../../layouts/BaseLayout.astro'
import PostTitle from '../../components/PostTitle.astro'
import DateFormatter from '../../components/DateFormatter.astro'
import { Image } from 'astro:assets'
import { getAllPostsSorted, getPostBySlug } from '../../lib/posts'

export async function getStaticPaths() {
  const posts = await getAllPostsSorted()
  return posts.map((post) => ({ params: { slug: post.slug } }))
}

const { slug } = Astro.params
const entry = slug ? await getPostBySlug(slug) : undefined
if (!entry) {
  throw new Error('Post not found')
}

const { Content } = await entry.render()
const { data } = entry
const pageTitle = `${data.title} | Decoding Disney`

function resolveAbsoluteUrl(url: string): string {
  return Astro.site ? new URL(url, Astro.site).toString() : url
}

const ogImage = data.ogImage?.url
  ? resolveAbsoluteUrl(data.ogImage.url)
  : resolveAbsoluteUrl(data.coverImage.src)
const ogImageWidth = data.ogImage?.url ? data.ogImage.width : 512
const ogImageHeight = data.ogImage?.url ? data.ogImage.height : 512
const canonicalUrl = Astro.site
  ? new URL(Astro.url.pathname, Astro.site).toString()
  : Astro.url.pathname
const modifiedDate = data.updatedDate ?? data.date

const structuredData = JSON.stringify({
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: data.title,
  description: data.excerpt,
  datePublished: data.date.toISOString(),
  dateModified: modifiedDate.toISOString(),
  image: ogImage,
  mainEntityOfPage: canonicalUrl,
  author: data.author?.name ? { '@type': 'Person', name: data.author.name } : undefined,
})
---

<BaseLayout
  title={pageTitle}
  description={data.excerpt}
  keywords={data.keywords}
  type="article"
  ogImage={ogImage}
  ogImageWidth={ogImageWidth}
  ogImageHeight={ogImageHeight}
  publishedTime={data.date.toISOString()}
  modifiedTime={modifiedDate.toISOString()}
  authorName={data.author.name}
>
  <main id="main-content">
    <div class="container mx-auto px-5">
      <article class="mb-32">
        <div class="mb-8 md:mb-16 sm:mx-0 flex justify-center">
          <div class="h-[512px] w-[512px]">
            <Image
              src={data.coverImage}
              alt={`Cover Image for ${data.title}`}
              class="shadow-sm w-full"
              width={512}
              height={512}
            />
          </div>
        </div>
        <div class="flex justify-center">
          <PostTitle>{data.title}</PostTitle>
        </div>
        <div class="flex justify-center max-w-2xl mx-auto mb-6 text-lg">
          <DateFormatter date={data.date} />
        </div>
        <div class="max-w-2xl mx-auto markdown">
          <Content />
        </div>
      </article>
    </div>
  </main>
  <script type="application/ld+json" is:inline set:html={structuredData} />
</BaseLayout>
