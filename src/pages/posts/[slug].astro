---
import BaseLayout from '../../layouts/BaseLayout.astro'
import PostTitle from '../../components/PostTitle.astro'
import DateFormatter from '../../components/DateFormatter.astro'
import { Image } from 'astro:assets'
import { getPostStaticPathEntries, type PostEntry } from '../../lib/posts'
import {
  DEFAULT_OG_IMAGE_HEIGHT,
  DEFAULT_OG_IMAGE_PATH,
  DEFAULT_OG_IMAGE_WIDTH,
  SITE_NAME,
  SITE_ORIGIN,
} from '../../lib/site'
import { buildArticleJsonLd, buildCanonicalUrl, buildPostOpenGraph } from '../../lib/seo'

export async function getStaticPaths() {
  return getPostStaticPathEntries()
}

const { entry } = Astro.props as { entry?: PostEntry }
if (!entry) {
  throw new Error('Post not found')
}

const { Content } = await entry.render()
const { data } = entry
const pageTitle = `${data.title} | ${SITE_NAME}`
const siteOrigin = Astro.site?.toString() ?? SITE_ORIGIN
const canonicalUrl = buildCanonicalUrl(Astro.url.pathname, siteOrigin)
const openGraph = buildPostOpenGraph(entry, siteOrigin, {
  path: DEFAULT_OG_IMAGE_PATH,
  width: DEFAULT_OG_IMAGE_WIDTH,
  height: DEFAULT_OG_IMAGE_HEIGHT,
})
const structuredData = JSON.stringify(buildArticleJsonLd(entry, canonicalUrl, openGraph.imageUrl))
---

<BaseLayout
  title={pageTitle}
  description={data.excerpt}
  keywords={data.keywords}
  type="article"
  canonicalUrl={canonicalUrl}
  ogImage={openGraph.imageUrl}
  ogImageWidth={openGraph.imageWidth}
  ogImageHeight={openGraph.imageHeight}
  publishedTime={openGraph.publishedTime}
  modifiedTime={openGraph.modifiedTime}
  authorName={openGraph.authorName}
>
  <main id="main-content">
    <div class="container mx-auto px-5">
      <article class="mb-32">
        <div class="mb-8 md:mb-16 sm:mx-0 flex justify-center">
          <div class="h-[512px] w-[512px]">
            <Image
              src={data.coverImage}
              alt={`Cover Image for ${data.title}`}
              class="shadow-sm w-full"
              width={512}
              height={512}
            />
          </div>
        </div>
        <div class="flex justify-center">
          <PostTitle>{data.title}</PostTitle>
        </div>
        <div class="flex justify-center max-w-2xl mx-auto mb-6 text-lg">
          <DateFormatter date={data.date} />
        </div>
        <div class="max-w-2xl mx-auto markdown">
          <Content />
        </div>
      </article>
    </div>
  </main>
  <script type="application/ld+json" is:inline set:html={structuredData} />
</BaseLayout>
